name: ğŸŒŸäº‘ç­¾åˆ°è‡ªåŠ¨åŒ–æ“ä½œå·¥ä½œæµğŸŒŸ

# å®šä¹‰è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
  # å½“ç”¨æˆ·å¯¹ä»“åº“è¿›è¡Œ watch æ“ä½œæ—¶è§¦å‘
  watch:
    types: [started]
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
  # å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹è§¦å‘ï¼ˆå¯¹åº” UTC æ—¶é—´ 16 ç‚¹ï¼‰
  schedule:
    - cron: '0 16 * * *'

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  build-and-deploy:
    # æŒ‡å®šä½œä¸šè¿è¡Œçš„ç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    runs-on: ubuntu-latest
    # æŒ‡å®šä½œä¸šè¿è¡Œæ—¶ä½¿ç”¨çš„ç¯å¢ƒå˜é‡
    environment: user
    steps:
      # æ­¥éª¤ 1: éšæœºå»¶è¿Ÿ 0 - 300 ç§’ï¼Œé¿å…é›†ä¸­è¯·æ±‚æœåŠ¡å™¨ï¼Œå¹¶æ˜¾ç¤ºç”Ÿæˆçš„æ—¶é—´
      - name: â±ï¸ éšæœºå»¶è¿Ÿï¼ˆ0 - 300 ç§’ï¼‰ä»¥åˆ†æ•£è¯·æ±‚å‹åŠ›
        run: |
          echo "==================== å¼€å§‹éšæœºå»¶è¿Ÿæ­¥éª¤ ===================="
          delay=$((RANDOM % 301))
          current_time=$(date +"%Y-%m-%d %H:%M:%S")
          echo "å½“å‰æ—¶é—´: $current_timeï¼Œå°†å»¶è¿Ÿ $delay ç§’åç»§ç»­..."
          sleep $delay
          echo "å»¶è¿Ÿ $delay ç§’å®Œæˆï¼Œç»§ç»­åç»­æ­¥éª¤ã€‚"
          echo "==================== éšæœºå»¶è¿Ÿæ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 2: æ£€å‡ºä»£ç åˆ°è¿è¡Œç¯å¢ƒ
      - name: ğŸ“¥ ä»ä»“åº“æ£€å‡ºä»£ç è‡³è¿è¡Œç¯å¢ƒ
        run: |
          echo "==================== å¼€å§‹æ£€å‡ºä»£ç æ­¥éª¤ ===================="
          echo "æ­£åœ¨æ£€å‡ºä»£ç ..."
          uses: actions/checkout@v4
          echo "ä»£ç æ£€å‡ºå®Œæˆã€‚"
          echo "==================== æ£€å‡ºä»£ç æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 3: è®¾ç½® Node.js ç¯å¢ƒï¼Œä½¿ç”¨ç‰ˆæœ¬ 18 å¹¶å¯ç”¨ npm ç¼“å­˜
      - name: âš™ï¸ é…ç½® Node.js 18 ç¯å¢ƒå¹¶å¯ç”¨ npm ç¼“å­˜
        run: |
          echo "==================== å¼€å§‹è®¾ç½® Node.js ç¯å¢ƒæ­¥éª¤ ===================="
          echo "æ­£åœ¨è®¾ç½® Node.js ç¯å¢ƒï¼Œç‰ˆæœ¬ 18ï¼Œå¯ç”¨ npm ç¼“å­˜..."
          uses: actions/setup-node@v4
          with:
            node-version: 18
            cache: npm
          echo "Node.js ç¯å¢ƒè®¾ç½®å®Œæˆã€‚"
          echo "==================== è®¾ç½® Node.js ç¯å¢ƒæ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 4: æ£€æŸ¥æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œå¦‚æœå¼€å¯åˆ™è®¾ç½®ç¯å¢ƒå˜é‡
      - name: ğŸ æ£€æŸ¥è°ƒè¯•æ¨¡å¼å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
        if: vars.debug == '1'
        run: |
          echo "==================== å¼€å§‹æ£€æŸ¥è°ƒè¯•æ¨¡å¼æ­¥éª¤ ===================="
          echo "è°ƒè¯•æ¨¡å¼å·²å¯ç”¨ã€‚è®¾ç½®ç¯å¢ƒå˜é‡ CLOUD189_VERBOSE=1ã€‚"
          echo "CLOUD189_VERBOSE=1" >> $GITHUB_ENV
          echo "è°ƒè¯•æ¨¡å¼æ£€æŸ¥åŠè®¾ç½®å®Œæˆã€‚"
          echo "==================== æ£€æŸ¥è°ƒè¯•æ¨¡å¼æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦å¯ç”¨ç¼“å­˜ Tokenï¼Œå¦‚æœå¯ç”¨åˆ™è®¾ç½®ç¯å¢ƒå˜é‡
      - name: ğŸ’¾ æ£€æŸ¥ Token ç¼“å­˜å¯ç”¨æƒ…å†µå¹¶è®¾ç½®ç¯å¢ƒå˜é‡
        if: vars.cacheToken == '1'
        run: |
          echo "==================== å¼€å§‹æ£€æŸ¥ç¼“å­˜ Token æ­¥éª¤ ===================="
          echo "ç¼“å­˜ Token å·²å¯ç”¨ã€‚è®¾ç½®ç¯å¢ƒå˜é‡ CACHE_TOKEN=1ã€‚"
          echo "CACHE_TOKEN=1" >> $GITHUB_ENV
          echo "ç¼“å­˜ Token æ£€æŸ¥åŠè®¾ç½®å®Œæˆã€‚"
          echo "==================== æ£€æŸ¥ç¼“å­˜ Token æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 6: æ¢å¤æˆ–ä¿å­˜ç¼“å­˜çš„ Token ç›®å½•
      - name: ğŸ’¿ æ¢å¤æˆ–ä¿å­˜ Token ç¼“å­˜ç›®å½•
        if: vars.cacheToken == '1'
        run: |
          echo "==================== å¼€å§‹ç¼“å­˜ Token ç›®å½•æ­¥éª¤ ===================="
          echo "æ­£åœ¨æ¢å¤æˆ–ä¿å­˜ç¼“å­˜çš„ Token ç›®å½•..."
          uses: actions/cache@v4
          with:
            path: .token
            key: ${{ runner.os }}-cache-token-${{ hashFiles('.token/*.json') }}
            restore-keys: ${{ runner.os }}-cache-token-
          echo "ç¼“å­˜ Token ç›®å½•æ“ä½œå®Œæˆã€‚"
          echo "==================== ç¼“å­˜ Token ç›®å½•æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 7: åˆå§‹åŒ–æœºå¯†ä¿¡æ¯ï¼Œå°†ä»“åº“çš„ secrets è½¬æ¢ä¸ºç¯å¢ƒå˜é‡
      - name: ğŸ”‘ åˆå§‹åŒ–æœºå¯†ä¿¡æ¯å¹¶è½¬æ¢ä¸ºç¯å¢ƒå˜é‡
        run: |
          echo "==================== å¼€å§‹åˆå§‹åŒ–æœºå¯†ä¿¡æ¯æ­¥éª¤ ===================="
          echo "æ­£åœ¨åˆå§‹åŒ–æœºå¯†ä¿¡æ¯..."
          uses: shine1594/secrets-to-env-action@master
          with:
            secrets: ${{ toJSON(secrets) }}
            secrets_env: production
            prefix_prod: ""
            file_name_prod: .env
          echo "æœºå¯†ä¿¡æ¯åˆå§‹åŒ–å®Œæˆã€‚"
          echo "==================== åˆå§‹åŒ–æœºå¯†ä¿¡æ¯æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 8: å®‰è£…é¡¹ç›®ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®æ‰€éœ€ä¾èµ–
        run: |
          echo "==================== å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–æ­¥éª¤ ===================="
          echo "å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm install
          echo "é¡¹ç›®ä¾èµ–å®‰è£…å®Œæˆã€‚"
          echo "==================== å®‰è£…é¡¹ç›®ä¾èµ–æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 9: è¿è¡Œé¡¹ç›®ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ
      - name: â–¶ï¸ è¿è¡Œé¡¹ç›®ï¼ˆæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡ 30 åˆ†é’Ÿï¼‰
        uses: nick-fields/retry@master
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: |
            echo "==================== å¼€å§‹è¿è¡Œé¡¹ç›®æ­¥éª¤ ===================="
            echo "å¼€å§‹è¿è¡Œé¡¹ç›®ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡å°è¯•è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ..."
            npm start
            echo "é¡¹ç›®è¿è¡Œå®Œæˆã€‚"
            echo "==================== è¿è¡Œé¡¹ç›®æ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 10: å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡ç©ºæäº¤å¹¶æ¨é€ä»£ç 
      - name: â° å®šæ—¶ä»»åŠ¡è§¦å‘ - ç©ºæäº¤å¹¶æ¨é€ä»£ç ä»¥ä¿æŒå·¥ä½œæµè¿è¡Œ
        if: github.event_name == 'schedule'
        run: |
          echo "==================== å¼€å§‹ä¿æŒå·¥ä½œæµè¿è¡Œæ­¥éª¤ ===================="
          echo "æ­¤å·¥ä½œæµç”±å®šæ—¶ä»»åŠ¡è§¦å‘ã€‚è¿›è¡Œä¸€æ¬¡ç©ºæäº¤å¹¶æ¨é€ä»£ç ..."
          git config --local user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git config --local user.name "${{ github.actor }}"
          git remote set-url origin https://${{ github.actor }}:${{ github.token }}@github.com/${{ github.repository }}
          git pull --rebase --autostash
          git commit --allow-empty -m "æŒç»­è¿è¡Œ..."
          git push
          echo "ç©ºæäº¤å¹¶æ¨é€ä»£ç å®Œæˆã€‚"
          echo "==================== ä¿æŒå·¥ä½œæµè¿è¡Œæ­¥éª¤ç»“æŸ ===================="

      # æ­¥éª¤ 11: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€æ–°çš„ 50 æ¡è®°å½•
      - name: ğŸ—‘ï¸ åˆ é™¤æ—§å·¥ä½œæµè®°å½•ï¼Œä¿ç•™æœ€æ–° 50 æ¡
        run: |
          echo "==================== å¼€å§‹åˆ é™¤æ—§å·¥ä½œæµè®°å½•æ­¥éª¤ ===================="
          echo "æ­£åœ¨åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€æ–°çš„ 50 æ¡è®°å½•..."
          uses: Mattraks/delete-workflow-runs@main
          with:
            token: ${{ github.token }}
            repository: ${{ github.repository }}
            retain_days: 0
            keep_minimum_runs: 50
          echo "æ—§å·¥ä½œæµè¿è¡Œè®°å½•åˆ é™¤å®Œæˆã€‚"
          echo "==================== åˆ é™¤æ—§å·¥ä½œæµè®°å½•æ­¥éª¤ç»“æŸ ===================="    
